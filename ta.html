<html>
<head>
<title>Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="https://news.yandex.ru/favicon.ico"/>
<link rel="icon" sizes="24x24" href="https://yastatic.net/iconostasis/_/lQHbCexSgizAhisugKD79mTz__Q.png" type="image/png"/>
<link rel="icon" sizes="32х32" href="https://yastatic.net/iconostasis/_/NOwNHktJskVNPZcTJcTvuXUXPzg.png" type="image/png"/>
<link rel="icon" sizes="64x64" href="https://yastatic.net/iconostasis/_/UBaaXgpU3qo2rqZuvG9gLzr7708.png" type="image/png"/>
<link rel="icon" sizes="96x96" href="https://yastatic.net/iconostasis/_/lcamcuh-DgDslnjBRGXI6VMyGLs.png" type="image/png"/>
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/152x152.png" type="image/png"/>
<meta name="msapplication-square70x70logo" content="/70x70.png"/>
<meta name="msapplication-square150x150logo" content="/150x150.png"/>
<meta name="msapplication-wide310x150logo" content="/310x150.png"/>
<meta name="msapplication-square310x310logo" content="/310x310.png"/>
<meta name="application-name" content="Новости"/>
<meta name="msapplication-TileColor" content="#FA6800"/>
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="sha512.js"></script>
<style>   
body, html { 
  width: 100%;
  height: 100%;
  background: black;
  margin: 0px;
  padding: 0px;
  scroll: none;
}
div.header{
  height: 20px;
  min-height: 20px;
  max-height: 20px;
  color: white;
  background: black;
  text-align: center;
}
div.header span {
  color: gray;
  padding-left: 10px;
  font-family: "Lucida Console", Monaco, monospace;
  font-size: 20px;
}
div.header a{
  font-family: "Lucida Console", Monaco, monospace;
  font-size: 20px;
  color: lightgreen;
  text-decoration: none;
}
div.pane {
  border-top: 1px solid #333;
  text-align: center;
}
#editor {        
  min-width: calc(100% - 30px);
  width: calc(100% - 30px);
  max-width: calc(100% - 30px);
  min-height: calc(100% - 40px);
  height: calc(100% - 40px);
  max-height: calc(100% - 40px);
  color: #fff;
  background: black;
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, "Lucida Console", Monaco, Courier, monospace;
  font-size: 20px;
  margin: 5px;
  border: 0px solid;
  caret-color: white;
}
textarea:focus {
  outline: none;
}
/* http://jsfiddle.net/hmartiro/Xck2A/1/ - scorollbar properties */
</style>
</head>    
<body>
<div class="header"><a href="#" onClick="enc()">ENC</a> | <a href="#" onClick="dec()">DEC</a></div>
<div class="pane"><textarea id="editor">test me!
line2
line3
line4
Я
2</textarea></div>
<script>
function crypt(str, psw, decode){
    var hash = sha512.create()    
    hash.update(psw)
    var mask = hash.array()
    var len = str.length
    var res = new Uint8Array(len)
    for(var i = 0; i < len; i++){
        res[i] = str[i] ^ mask[i % 64]
        if((i+1) % 64 == 0){
            hash = sha512.create()
            var x = decode ? res.slice(i-63,i+1) : str.slice(i-63,i+1) 
            var c = new Uint8Array(psw.length + x.length);
            c.set(psw, 0);
            c.set(x, psw.length);
            hash.update(c)
            mask = hash.array()
        }
    }
    return res
}
function getPsw(){
    return 'test'
}
function enc(){
    var psw = getPsw()
    var msg = document.getElementById('editor').value
    psw = new TextEncoder("utf-8").encode(psw)
    msg = new TextEncoder("utf-8").encode(msg)
    var data = crypt(msg, psw, false)
    data = String.fromCharCode.apply(null, data)
    var msg = window.btoa(data)
    var msg2 = ''
    for(var i = 0; i < msg.length; i += 64){
        msg2 += msg.substring(i, i+64) + '\n'
    }
    document.getElementById('editor').value = msg2
    document.getElementById('editor').select();
    document.execCommand("Copy");
    window.getSelection().removeAllRanges();
}
function dec(){
    var psw = getPsw()
    var msg = window.atob(document.getElementById('editor').value)
    var list = [];
    for(var i = 0; i < msg.length; i++){
        list.push(msg.charCodeAt(i))
    }
    msg = new Uint8Array(list)
    psw = new TextEncoder("utf-8").encode(psw)
    document.getElementById('editor').value = new TextDecoder("utf-8").decode(crypt(msg, psw, true))
}
</script>
</body>
</html>
